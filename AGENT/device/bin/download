#!/data/Software/mydan/perl/bin/perl
use strict;
use warnings;
use FindBin qw( $RealBin );
use YAML::XS;

=head1 SYNOPSIS

 $0

=cut

my $config = "$RealBin/../conf/config.yml";
exit unless -f $config;

my $conf = eval{ YAML::XS::LoadFile $config };
die "load confg fail: $@" if $@;

my $runpath = "$RealBin/../run/download";
system "mkdir -p $runpath" unless -d $runpath;

chdir $runpath or die "chdir fail";

if( $conf->{cookie} && $conf->{cookie}{cmd} )
{
    system $conf->{cookie}{cmd};
}

system "rm -rf temp; mkdir temp";

sub download
{
    my ( $type, $subtype, $url, $outline ) = @_;

    my ( $temppath, $distpath ) = ( "temp/$type/$subtype", "/data/open-c3-data/device/curr/$type/$subtype" );

    system "mkdir -p $temppath" unless -d $temppath;
    system "mkdir -p $distpath" unless -d $distpath;

    system "curl -b cookie '$url' -o            $temppath/data.xlsx";
    system "xlsx2csv   -o $temppath/temp.tsv $temppath/data.xlsx ";
    system "cat $temppath/temp.tsv | sed '1d' > $temppath/data.tsv ";

    eval{ YAML::XS::DumpFile "temp/$type/$subtype/outline.yml", $outline; };

    system "mv $temppath/data.tsv    $distpath/";
    system "mv $temppath/outline.yml $distpath/";
}

map{
    my $c = $_;
    download( map{ $c->{$_} }qw(type subtype url outline ));
}@{ $conf->{download} };
