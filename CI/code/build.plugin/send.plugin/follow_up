#!/data/Software/mydan/perl/bin/perl -I/data/Software/mydan/CI/lib -I/data/Software/mydan/CI/private/lib
use strict;
use warnings;
use Code;
use Logs;

$| ++;

=head1 SYNOPSIS

    db => $mysql,
    logs => 日志对象

    uuid => version的uuid

#只有使用uuid来构建的时候才允许send

=cut

return sub
{
    my %param = @_;

    my ( $db, $logs, $uuid, $projectid, $version, $follow_up ) 
        = @param{qw( db logs uuid projectid version follow_up )};

    print "=" x 75, "\n";
    print "follow_up($follow_up)...\n";

    $logs = Logs->new( 'code.build.send.follow_up' ) unless $logs;
    $logs->die( "format error" ) unless $follow_up =~ /^[a-zA-Z0-9][a-zA-Z0-9\._,\|\- \/\:=]*$/ &&  $follow_up !~ /\.\./;

    my $name = eval{ Code->new( "projectname" )->run( id => $projectid ); };
    $logs->die( "get projectname fail:$@" ) if $@;
    print "projectname: $name\n";
    $logs->die( "projectname format error" ) unless $name && $name =~ /^[a-zA-Z0-9][a-zA-Z0-9\._\-]+$/;

    if ($follow_up =~ /\|/g) {
        my @infos = split(/\|/, $follow_up);
        my $cmd;
        map{
            $_ =~ s/^ +//;
            $cmd = "PROJECTNAME=$name VERSION=$version PROJECTID=$projectid /data/ci-scripts/$_";
            $logs->die( "run build.send.follow_up fail:$!" ) if system "$cmd";
            }@infos;
    } else {
        my $cmd = "PROJECTNAME=$name VERSION=$version PROJECTID=$projectid /data/ci-scripts/$follow_up";
        $logs->die( "run build.send.follow_up fail:$!" ) if system "$cmd";
    };

}
