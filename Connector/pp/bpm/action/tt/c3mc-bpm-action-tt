#!/usr/bin/env /data/Software/mydan/python3/bin/python3
# -*- coding: utf-8 -*-

import sys
import json
import subprocess
import re
import base64
import os
import shutil
import uuid


sys.path.append("/data/Software/mydan/Connector/lib/pp")
from c3mc_utils import safe_run_command, duplicate_file


def replace_base64_substring(long_string):
    base64_regex = r'base64__\s*([\s\S]*?)__base64'
    matches = re.findall(base64_regex, long_string)

    for match in matches:
        base64_string = match
        decoded_bytes = base64.b64decode(base64_string)
        decoded_string = decoded_bytes.decode('utf-8')
        string_with_colon = f': {decoded_string}'
        long_string = long_string.replace(f'base64__{match}__base64', string_with_colon)

    return long_string


def upload_attach(tt_number, target_file_path):
    output = safe_run_command([
        "c3mc-upload-attach-for-ticket",
        "--tt_id", tt_number.lstrip("T").lstrip("0"),
        "--file_path", target_file_path,
    ])


def get_tt_content(params):
    """不同工单的内容可能不一样，这里在发起tt工单之前对content字段做必要的修改
    """
    content = params["content"]
    if "SQL操作" in params["title"] and params["sql_input_type"] == "上传附件":
        content = '\n'.join([line for line in content.split('\n') if not line.startswith("SQL语句")])
    else:
        content = replace_base64_substring(content)
    
    return content


def upload_attach_if_need(tt_number, params):
    if "SQL操作" in params["title"] and params["sql_input_type"] == "上传附件":
        target_file_path, clean_file = duplicate_file(
            f"/data/open-c3-data/bpm/attachments/{params['sql_file'].split(':')[0]}", 
            f"/data/open-c3-data/bpm/attachments/{params['sql_file'].split(':')[1]}"
        )
        upload_attach(tt_number, target_file_path)
        clean_file()


def create_tt(params):
    print("params = ", json.dumps(params))

    content = get_tt_content(params)

    submit_user = params['submit_user'] if 'submit_user' in params else "sys@app"
    ext_tt = subprocess.getoutput("c3mc-sys-ctl sys.bpm.tt.type")

    resp = subprocess.run([
            "c3mc-create-ticket", 
            "--submit_user", submit_user, 
            "--apply_user", params["apply_user"], 
            "--title", params["title"], 
            "--ext_tt", ext_tt,
        ], 
        input=content.encode(), 
        stdout=subprocess.PIPE,
        stderr=subprocess.PIPE,
    )
    if resp.returncode != 0:
        err = resp.stderr.decode('utf-8').rstrip()
        print(f"LOG. 创建tt出错: {err}", file=sys.stderr)
        exit(1)

    tt_number = resp.stdout.decode('utf-8').rstrip()

    print(f"LOG. tt单号: {tt_number}")

    upload_attach_if_need(tt_number, params)

    notify = params.get("notify")
    if not notify:
        notify = "@bpm_notify"

    os.system( "echo 有工单需要处理, [ " + params["title"]  + " ] $(c3mc-sys-ctl sys.c3webaddr)/tt/#/tt/show/" + tt_number + "|c3mc-base-sendmesg $(c3mc-app-usrext bpm_notify @bpm_notify " + notify + "|xargs -n 10000)" )

    print(flush=True)

    resp = subprocess.run([
        "c3mc-wait-ticket-status-change",
        "--number", tt_number,
        "--ext_tt", ext_tt,
        ], 
        input=content.encode(), 
        stdout=subprocess.PIPE,
    )
    if resp.returncode != 0:
        err = resp.stderr.decode('utf-8').rstrip()
        print(f"LOG. 等待tt结束出错: {err}")
        exit(1)

    tt_status_txt = resp.stdout.decode('utf-8').rstrip()
    print(f"LOG. tt结束, 单号: {tt_number}, 状态: {tt_status_txt}")


def main(params):
    create_tt(params)
    

if __name__ == '__main__':
    l = list(sys.stdin)
    if not l or len(l) > 1:
        raise type('WrongInputData', (Exception,), {})('数据格式不对, 需要一行json字符串"')
    
    main(json.loads(l[0]))
