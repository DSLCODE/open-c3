#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import json
import sys
import statistics

import boto3


class Ec2Price:
    def __init__(self, access_id, access_key):
        self.access_id = access_id
        self.access_key = access_key
        self.client = self.create_client()

    def create_client(self):
        client = boto3.client(
            "pricing",
            aws_access_key_id=self.access_id,
            aws_secret_access_key=self.access_key,
            region_name="us-east-1",
        )
        return client

    def query_hour_price(self, region, instance_type):
        if region.startswith("cn-"):
            sys.path.append("/data/Software/mydan/Connector/lib/pp")
            from c3mc_cloud_aws_china_get_price_data import get_ec2_price
            return get_ec2_price(region, instance_type)
        else:
            FLT = '[{{"Field": "preInstalledSw", "Value": "NA", "Type": "TERM_MATCH"}},'\
                '{{"Field": "instanceType", "Value": "{t}", "Type": "TERM_MATCH"}},'\
                '{{"Field": "regionCode", "Value": "{r}", "Type": "TERM_MATCH"}},'\
                '{{"Field": "capacitystatus", "Value": "Used", "Type": "TERM_MATCH"}}]'
            f = FLT.format(r=region, t=instance_type)
            data = self.client.get_products(
                ServiceCode='AmazonEC2', Filters=json.loads(f))

            pl = []
            mt = ""
            for item in data['PriceList']:
                od = json.loads(item)['terms']['OnDemand']
                id1 = list(od)[0]
                id2 = list(od[id1]['priceDimensions'])[0]
                od = od[id1]['priceDimensions'][id2]['pricePerUnit']

                amount = float(od[list(od)[0]])
                if amount == 0:
                    continue
                pl.append(amount)
                if mt == "":
                    mt = list(od)[0]

            return {
                "amount": statistics.mean(pl),
                "money_type": mt,
            }

    def query_month_price(self, region, instance_type):
        """
            os参数可以传 linux 或者 windows
        """
        hour_price = self.query_hour_price(region, instance_type)
        # 一个月的小时数 = 365天 * 24小时 / 12个月
        return "{} {}".format(round(float(hour_price["amount"]) * 730, 2), hour_price["money_type"])


def main(access_id, access_key, region, instance_type):
    price = Ec2Price(access_id, access_key).query_month_price(region, instance_type)
    print(price)


if __name__ == '__main__':
    main(sys.argv[1], sys.argv[2], sys.argv[3], sys.argv[4])
